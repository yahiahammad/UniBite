<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - UniBite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/Styles/checkout.css">
</head>
<body>
    <div class="checkout-container">
        <!-- Main Checkout Section -->
        <div class="checkout-section">
            <a href="/cart" class="back-to-cart">
                <i class="fas fa-arrow-left"></i>
                Back to Cart
            </a>
            
            <h2 class="section-title">Checkout</h2>

            <!-- Order Items -->
            <div class="order-items">
                <h3 class="section-title">Order Items</h3>
                <div id="order-items-container">
                    <!-- Items will be populated by JavaScript -->
                </div>
            </div>

            <!-- Payment Method -->
            <div class="payment-methods">
                <h3 class="section-title">Payment Method</h3>
                <div class="payment-option selected">
                    <input type="radio" name="payment" id="cash" checked>
                    <i class="fas fa-money-bill payment-icon"></i>
                    <div>
                        <h4>Cash on Pickup</h4>
                        <p>Pay with cash when you pick up your order</p>
                    </div>
                </div>
            </div>

            <!-- Order Notes -->
            <div class="order-notes">
                <h3 class="section-title">Order Notes</h3>
                <textarea class="notes-input" placeholder="Add any special instructions or notes for your order..."></textarea>
            </div>
        </div>

        <!-- Order Summary Section -->
        <div class="order-summary">
            <h3 class="section-title">Order Summary</h3>
            <div class="summary-item">
                <span>Subtotal</span>
                <span id="subtotal">0 EGP</span>
            </div>
            <div class="summary-item">
                <span>Pickup Fee</span>
                <span>Free</span>
            </div>
            <div class="summary-total">
                <span>Total</span>
                <span id="total">0 EGP</span>
            </div>
            <button class="confirm-button" onclick="confirmOrder()">Confirm Order</button>
        </div>
    </div>

    <script>
        // Handle payment method selection
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                // Add selected class to clicked option
                this.classList.add('selected');
                // Check the radio button
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Load cart from localStorage
        function getCartObj() {
            try {
                return JSON.parse(localStorage.getItem('cartObj')) || {};
            } catch (e) { return {}; }
        }

        function getCart() {
            const cartObj = getCartObj();
            return cartObj.items || [];
        }

        // Render cart items
        function renderCart() {
            const cart = getCart();
            const container = document.getElementById('order-items-container');
            let subtotal = 0;

            container.innerHTML = '';
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
                const div = document.createElement('div');
                div.className = 'order-item';
                div.innerHTML = `
                    <div class="item-details">
                        <div class="item-image" style="background-image: url('${item.image}')"></div>
                        <div class="item-info">
                            <h4>${item.name}</h4>
                            <p>${item.category}</p>
                            <div class="item-quantity">
                                <span>Quantity: ${item.quantity}</span>
                            </div>
                        </div>
                    </div>
                    <div class="item-price">${item.price * item.quantity} EGP</div>
                `;
                container.appendChild(div);
            });

            document.getElementById('subtotal').textContent = subtotal + ' EGP';
            document.getElementById('total').textContent = subtotal + ' EGP';
        }

        // Handle order confirmation
        async function confirmOrder() {
            try {
                const cart = getCart();
                if (cart.length === 0) {
                    alert('Your cart is empty!');
                    return;
                }

                // Get order notes
                const notes = document.querySelector('.notes-input').value;
                
                // Submit order to server
                const response = await fetch('/api/orders/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: cart,
                        notes: notes
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Clear cart from localStorage
                    localStorage.removeItem('cartObj');
                    // Redirect to order confirmation page with order ID
                    window.location.href = `/order/confirmation?id=${data.orderId}`;
                } else {
                    alert('Order failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('Failed to submit order. Please try again.');
            }
        }

        // Initial render
        renderCart();
    </script>
</body>
</html> 