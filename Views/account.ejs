<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account - UniBite</title>
  <meta name="description" content="Manage your UniBite account settings and view your order history.">
  <link rel="stylesheet" href="Styles/styles.css">
  <link rel="stylesheet" href="Styles/account.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <%- include('partials/Header', { active: 'account' }) %>


  <main class="account-page">
    <div class="container">
      <div class="account-header">
        <a href="index.html" class="back-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back
        </a>
        <h1>Account</h1>
      </div>

      <div class="account-tabs">
        <div class="tabs-header">
          <button class="tab-btn active" data-tab="personal-info">Personal Info</button>
          <button class="tab-btn" data-tab="security">Security</button>
          <button class="tab-btn" data-tab="orders">Orders</button>
        </div>

        <div class="tabs-content">
          <!-- Personal Info Tab -->
          <div class="tab-pane active" id="personal-info">
            <div class="account-grid">
              <div class="account-card">
                <div class="card-header">
                  <h2>Personal Information</h2>
                  <p>Update your personal details</p>
                </div>
                <div class="card-content">
                  <form id="personal-info-form">
                    <div class="form-group">
                      <label for="name">Full Name</label>
                      <input type="text" id="name" name="name" placeholder="<%= user.name %>" value="<%= user.name %>">
                    </div>
                    <div class="form-group">
                      <label for="email">Email Address</label>
                      <input type="email" id="email" name="email" value="<%= user.email %>" disabled class="input-disabled">
                      <p class="input-hint">Your email address cannot be changed as it's linked to your MIU account.</p>
                    </div>
                    <div class="form-group">
                      <label for="phone">Phone Number</label>
                      <input type="tel" id="phone" name="phone" placeholder="<%= user.phone || '+20 123 456 789' %>" value="<%= user.phone || '+20 123 456 789' %>">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                  </form>
                </div>
              </div>

              <div class="account-card">
                <div class="card-header">
                  <h2>Account Information</h2>
                  <p>Your account details and preferences</p>
                </div>
                <div class="card-content">
                  <div class="info-group">
                    <h3>Account Type</h3>
                    <p><%= user.userType === 'admin' ? 'Executive' : 'Student' %></p>
                  </div>
                  <div class="info-group">
                    <h3>Member Since</h3>
                    <p id="member-since"></p>
                  </div>
                  <div class="divider"></div>
                  <div class="info-group">
                    <h3>Notification Preferences</h3>
                    <div class="toggle-group">
                      <div class="toggle-item">
                        <label for="order-updates">Order Updates</label>
                        <input type="checkbox" id="order-updates" class="toggle" checked>
                      </div>
                      <div class="toggle-item newsletter-toggle">
                        <div class="toggle-label">
                          <label for="newsletter">Newsletter</label>
                          <p class="input-hint">Receive updates about new features and special offers. You can change this preference once every 24 hours.</p>
                        </div>
                        <input type="checkbox" id="newsletter" class="toggle" <%= user.newsletterSubscribed ? 'checked' : '' %>>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Security Tab -->
          <div class="tab-pane" id="security">
            <div class="account-card">
              <div class="card-header">
                <h2>Change Password</h2>
                <p>Update your password to keep your account secure</p>
              </div>
              <div class="card-content">
                <form id="password-form">
                  <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <div class="password-input">
                      <input type="password" id="currentPassword" name="currentPassword">
                      <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <div class="password-input">
                      <input type="password" id="newPassword" name="newPassword">
                      <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                      </button>
                    </div>
                    <p class="input-hint">Password must be at least 8 characters long.</p>
                  </div>
                  <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password</label>
                    <div class="password-input">
                      <input type="password" id="confirmNewPassword" name="confirmNewPassword">
                      <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary">Change Password</button>
                </form>
              </div>
            </div>

            <div class="account-card">
              <div class="card-header">
                <h2>Account Security</h2>
                <p>Additional security options for your account</p>
              </div>
              <div class="card-content">
                <div class="info-group">
                  <h3>Two-Factor Authentication</h3>
                  <p>Add an extra layer of security to your account by enabling two-factor authentication.</p>
                  <button class="btn btn-outline">Enable 2FA</button>
                </div>
                <div class="divider"></div>
                <div class="info-group">
                  <h3>Recent Logins</h3>
                  <div class="login-item">
                    <p class="login-date">Today, 8:52 PM</p>
                    <p class="login-device">Cairo, Egypt • Chrome on Windows</p>
                  </div>
                  <div class="login-item">
                    <p class="login-date">May 10, 2025, 12:30 PM</p>
                    <p class="login-device">Cairo, Egypt • Safari on iPhone</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Order History Tab -->
          <div class="tab-pane" id="orders">
            <div class="tabs">
              <button class="tab active" data-tab="ongoing">Ongoing Orders</button>
              <button class="tab" data-tab="history">Order History</button>
            </div>

            <!-- Ongoing Orders Section -->
            <div class="order-section" id="ongoing-order-history">
              <h2>Ongoing Orders</h2>
              <div id="ongoing-orders-list">
                <div class="loading-spinner">Loading orders...</div>
              </div>
            </div>

            <!-- Order History Section -->
            <div class="order-section hidden" id="history-order-history">
              <h2>Order History</h2>
              <div id="order-history-list">
                <div class="loading-spinner">Loading orders...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-copyright">
          <p>&copy; <span id="current-year">2025</span> UniBite. All rights reserved.</p>
        </div>
        <div class="footer-links">
          <a href="about.html">About</a>
          <a href="help.html">Help</a>
          <a href="privacy.html">Privacy</a>
          <a href="terms.html">Terms</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <div class="toast-content">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toast-icon">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      <div class="toast-message">
        <h4>Success</h4>
        <p>Your changes have been saved successfully.</p>
      </div>
    </div>
    <button class="toast-close">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <script src="js/main.js"></script>
  <script src="js/account.js"></script>
  <script>
    // Function to switch between tabs
    function switchTab(tabName) {
      console.log('Switching to tab:', tabName); // Debug log
      
      // Hide all sections
      document.querySelectorAll('.order-section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected section and activate tab
      const section = document.getElementById(tabName + '-order-history');
      const tab = document.querySelector(`.tab[data-tab="${tabName}"]`);
      
      console.log('Section element:', section); // Debug log
      console.log('Tab element:', tab); // Debug log
      
      if (section) section.classList.remove('hidden');
      if (tab) tab.classList.add('active');
    }

    // Add click event listeners to tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        console.log('Tab clicked:', tab.dataset.tab); // Debug log
        switchTab(tab.dataset.tab);
      });
    });

    // Function to load orders
    async function loadOrders() {
      try {
        const response = await fetch('/api/orders/user');
        if (!response.ok) {
          throw new Error('Failed to fetch orders');
        }
        
        const orders = await response.json();
        console.log('Fetched orders:', orders);
        
        // Separate ongoing and completed orders based on actual status values
        const ongoingOrders = orders.filter(order => 
          ['pending', 'preparing', 'ready for pickup'].includes(order.status.toLowerCase())
        );
        const completedOrders = orders.filter(order => 
          ['picked up', 'cancelled'].includes(order.status.toLowerCase())
        );

        console.log('Ongoing orders:', ongoingOrders);
        console.log('Completed orders:', completedOrders);

        // Sort orders by date (newest first)
        ongoingOrders.sort((a, b) => new Date(b.orderTime) - new Date(a.orderTime));
        completedOrders.sort((a, b) => new Date(b.orderTime) - new Date(a.orderTime));

        // Render ongoing orders
        const ongoingList = document.getElementById('ongoing-orders-list');
        if (ongoingOrders.length === 0) {
          ongoingList.innerHTML = '<p class="no-orders">No ongoing orders at the moment.</p>';
        } else {
          ongoingList.innerHTML = ongoingOrders.map(order => createOrderCard(order)).join('');
        }

        // Render order history
        const historyList = document.getElementById('order-history-list');
        if (completedOrders.length === 0) {
          historyList.innerHTML = '<p class="no-orders">No order history available.</p>';
        } else {
          historyList.innerHTML = completedOrders.map(order => createOrderCard(order)).join('');
        }

        // Make sure the correct tab is shown
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
          switchTab(activeTab.dataset.tab);
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ongoing-orders-list').innerHTML = 
          '<p class="error-message">Error loading orders. Please try again later.</p>';
        document.getElementById('order-history-list').innerHTML = 
          '<p class="error-message">Error loading orders. Please try again later.</p>';
      }
    }

    // Function to create order card HTML
    function createOrderCard(order) {
      const statusClass = order.status.toLowerCase().replace(/\s+/g, '-');
      const paymentClass = order.paymentStatus.toLowerCase();
      
      return `
        <div class="order-card ${statusClass}">
          <div class="order-header">
            <div>
              <span class="order-id">Order #${order._id.toString().slice(-6)}</span>
              <span class="payment-status payment-${paymentClass}">
                ${order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1)}
              </span>
            </div>
            <div class="order-status-container">
              <span class="order-status status-${statusClass}">
                ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
              </span>
              ${order.status === 'preparing' ? `
                <div class="estimated-time">
                  <i class="fas fa-hourglass-half"></i>
                  <span>Estimated time: 15-20 mins</span>
                </div>
              ` : order.status === 'ready for pickup' ? `
                <div class="estimated-time">
                  <i class="fas fa-box"></i>
                  <span>Ready for pickup now</span>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="vendor-info">
            <img src="/Images/store-logo.png" alt="${order.vendorId.name} Logo" class="vendor-logo">
            <span>${order.vendorId.name}</span>
          </div>

          <div class="order-times">
            <div class="order-time">
              <i class="fas fa-clock"></i>
              <span>Ordered: ${new Date(order.orderTime).toLocaleString()}</span>
            </div>
            ${order.acceptedTime ? `
              <div class="order-time">
                <i class="fas fa-check-circle"></i>
                <span>Accepted: ${new Date(order.acceptedTime).toLocaleString()}</span>
              </div>
            ` : ''}
            ${order.pickupTime ? `
              <div class="order-time">
                <i class="fas fa-box"></i>
                <span>Picked Up: ${new Date(order.pickupTime).toLocaleString()}</span>
              </div>
            ` : ''}
          </div>

          <div class="order-items">
            ${order.items.map(item => `
              <div class="order-item">
                <span>${item.nameAtOrder}</span>
                <span>x${item.quantity} - ${item.priceAtOrder} EGP</span>
              </div>
            `).join('')}
          </div>

          ${order.notes ? `
            <div class="order-notes">
              <i class="fas fa-info-circle"></i>
              ${order.notes}
            </div>
          ` : ''}

          <div class="order-total">
            Total: ${order.totalPrice} EGP
          </div>
        </div>
      `;
    }

    // Load orders when the orders tab is clicked
    const ordersTab = document.querySelector('[data-tab="orders"]');
    if (ordersTab) {
      ordersTab.addEventListener('click', loadOrders);
    }

    // Load orders immediately if we're on the orders page
    if (document.getElementById('orders')) {
      loadOrders();
    }
  </script>
</body>
</html>
